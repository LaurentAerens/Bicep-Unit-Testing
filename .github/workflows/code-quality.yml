name: Code Quality & Security

on:
  push:
    branches: [main, master]
    paths:
      - 'framework/*.ps1'
      - '.github/workflows/code-quality.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'framework/*.ps1'
      - '.github/workflows/code-quality.yml'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write  # For Semgrep SARIF upload

jobs:
  psscriptanalyzer:
    name: PowerShell Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Set-PSRepository -Name 'PSGallery' -InstallationPolicy Trusted
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          $results = Invoke-ScriptAnalyzer -Path ./framework -Recurse -ReportSummary -EnableExit
          
          if ($results) {
            Write-Host "PSScriptAnalyzer found issues:" -ForegroundColor Red
            $results | Format-Table -AutoSize
            exit 1
          } else {
            Write-Host "PSScriptAnalyzer: No issues found!" -ForegroundColor Green
          }

      - name: Run PSScriptAnalyzer with SARIF output
        if: always()
        shell: pwsh
        run: |
          $sarifPath = "psscriptanalyzer-results.sarif"
          Invoke-ScriptAnalyzer -Path ./framework -Recurse -Settings PSGallery -SaveAs "sarif" -ReportSummary | Out-File -FilePath $sarifPath
          
          # Check if SARIF file was created and has content
          if (Test-Path $sarifPath) {
            $content = Get-Content $sarifPath -Raw
            if ([string]::IsNullOrWhiteSpace($content)) {
              # Create minimal valid SARIF if empty
              @{
                version = "2.1.0"
                '$schema' = "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json"
                runs = @(@{
                  tool = @{
                    driver = @{
                      name = "PSScriptAnalyzer"
                      version = "1.0.0"
                    }
                  }
                  results = @()
                })
              } | ConvertTo-Json -Depth 10 | Out-File -FilePath $sarifPath
            }
          }

      - name: Upload SARIF results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: psscriptanalyzer-results.sarif
          category: psscriptanalyzer

  semgrep:
    name: Semgrep Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep
        uses: semgrep/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/command-injection
            p/insecure-transport

      - name: Upload Semgrep SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
          category: semgrep

  summary:
    name: Quality Check Summary
    runs-on: ubuntu-latest
    needs: [psscriptanalyzer, semgrep]
    if: always()

    steps:
      - name: Check results
        run: |
          if [[ "${{ needs.psscriptanalyzer.result }}" == "failure" ]] || [[ "${{ needs.semgrep.result }}" == "failure" ]]; then
            echo "❌ Code quality checks failed"
            exit 1
          else
            echo "✅ All code quality checks passed"
          fi
